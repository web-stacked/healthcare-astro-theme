---
// Import the components from the astro-navbar npm package
import { Astronav, MenuItems, MenuIcon } from "astro-navbar";
import Icon from "./Icon.astro";
import nav from "../data/navigation.json";

const normalizePath = (path: string) =>
  path === "/" ? "/" : path.replace(/\/$/, "");
const currentPath = normalizePath(Astro.url.pathname || "/");
const isCurrentPage = (href: string) => {
  const target = normalizePath(href);
  if (target === "/") return currentPath === "/";
  return currentPath === target || currentPath.startsWith(`${target}/`);
};
---

<header
  class="sticky top-0 z-50 bg-theme-surface/98 backdrop-blur-lg supports-[backdrop-filter]:bg-theme-surface/95 border-b border-theme-border"
>
  <div class="container">
    <Astronav>
      <div class="flex items-center justify-between w-full py-4 lg:py-5">
        <!-- Logo -->
        <a href="/" class="shrink-0 flex items-center group relative z-10">
          <div
            class="text-2xl lg:text-3xl font-display font-bold text-theme-primary transition-transform duration-300 group-hover:scale-[1.02] whitespace-nowrap"
          >
            {nav.brand.name}
          </div>
        </a>

        <!-- Desktop Navigation -->
        <nav class="hidden lg:flex items-center gap-1">
          <ul class="flex items-center gap-0.5">
            {
              nav.links.map((link) => (
                <li>
                  <a
                    class="nav-link"
                    href={link.href}
                    aria-current={isCurrentPage(link.href) ? "page" : undefined}
                  >
                    {link.label}
                  </a>
                </li>
              ))
            }
          </ul>

          <!-- Theme Switcher -->
          <div class="relative" id="nav-theme-switcher">
            <button
              id="nav-theme-toggle"
              class="flex items-center gap-1.5 px-3 py-2 rounded-lg text-sm font-medium text-theme-text-secondary hover:text-theme-primary hover:bg-theme-surface-hover transition-colors duration-200"
              aria-label="Switch theme"
              aria-expanded="false"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
              </svg>
              <span>Theme</span>
              <svg class="w-3 h-3 transition-transform duration-200" id="nav-theme-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            <div
              id="nav-theme-dropdown"
              class="absolute top-full right-0 mt-2 w-64 bg-theme-surface rounded-xl shadow-lg border border-theme-border overflow-hidden transform scale-95 opacity-0 pointer-events-none transition-all duration-200 origin-top-right z-50"
            >
              <div class="p-2 max-h-72 overflow-y-auto" id="nav-theme-options">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Desktop CTA -->
          <div class="ml-4 pl-4 border-l border-theme-border">
            <a
              class="button button-primary text-sm"
              href={nav.cta.href}
            >
              {nav.cta.label}
            </a>
          </div>
        </nav>

        <!-- Mobile Menu Button -->
        <div class="lg:hidden flex items-center">
          <MenuIcon class="w-6 h-6 text-theme-text-secondary" />
        </div>
      </div>

      <!-- Mobile Navigation Menu -->
      <MenuItems class="hidden lg:hidden mobile-menu">
        <nav class="bg-theme-surface border-t border-theme-border shadow-md">
          <div class="max-w-md mx-auto px-4 py-6">
            <ul class="space-y-1 mb-6">
              {
                nav.links.map((link) => (
                  <li>
                    <a
                      class="mobile-nav-link group flex items-center px-4 py-3 text-base font-medium text-theme-text-secondary hover:text-theme-primary hover:bg-theme-surface-hover transition-colors duration-200 rounded-xl"
                      href={link.href}
                      aria-current={isCurrentPage(link.href) ? "page" : undefined}
                    >
                      <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-theme-surface-muted group-hover:bg-theme-surface-hover transition-colors mr-3 flex items-center justify-center">
                        <Icon
                          name={link.icon as any}
                          size="md"
                          class="text-theme-text-secondary group-hover:text-theme-primary transition-colors"
                        />
                      </div>
                      <span>{link.label}</span>
                    </a>
                  </li>
                ))
              }
            </ul>

            <!-- CTA Button -->
            <div class="pt-4 border-t border-theme-border">
              <a
                class="button button-primary w-full justify-center text-base"
                href={nav.cta.href}
              >
                {nav.cta.label}
              </a>
            </div>
          </div>
        </nav>
      </MenuItems>
    </Astronav>
  </div>
</header>

<style>
  .mobile-menu {
    animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .mobile-nav-link:active {
    transform: scale(0.98);
  }

  /* Active link highlighting */
  .nav-link[aria-current="page"],
  .mobile-nav-link[aria-current="page"] {
    color: var(--color-theme-primary);
    background-color: var(--color-theme-surface-hover);
  }

  /* Mobile menu button styling */
  #astronav-menu {
    padding: 0.5rem;
    margin-right: -0.5rem;
    border-radius: 0.5rem;
    transition: background-color 150ms ease;
  }

  #astronav-menu:hover {
    background-color: var(--color-theme-surface-hover);
  }

  #nav-theme-chevron.rotate {
    transform: rotate(180deg);
  }
</style>

<script>
  import {
    themePresets,
    getCurrentThemeId,
    saveThemePreference,
  } from "../lib/theme-presets";

  function setupNavThemeSwitcher() {
    const toggle = document.getElementById("nav-theme-toggle");
    const dropdown = document.getElementById("nav-theme-dropdown");
    const optionsContainer = document.getElementById("nav-theme-options");
    const chevron = document.getElementById("nav-theme-chevron");

    if (!toggle || !dropdown || !optionsContainer) return;
    const toggleEl = toggle as HTMLButtonElement;
    const dropdownEl = dropdown as HTMLDivElement;
    const optionsEl = optionsContainer as HTMLDivElement;
    const chevronEl = chevron as HTMLElement | null;

    if (toggleEl.dataset.bound === "true") return;
    toggleEl.dataset.bound = "true";

    let isOpen = false;

    function renderOptions() {
      const currentTheme = getCurrentThemeId();
      optionsEl.innerHTML = themePresets
        .map(
          (theme) => `
          <button
            data-theme-id="${theme.id}"
            class="nav-theme-option w-full flex items-center gap-3 p-2.5 rounded-lg transition-colors duration-200 hover:bg-theme-surface-hover ${
              theme.id === currentTheme ? "bg-theme-primary/10" : ""
            }"
          >
            <div
              class="w-6 h-6 rounded-full ring-1 ring-black/10 shadow-sm flex-shrink-0"
              style="background: linear-gradient(135deg, ${theme.colors.primary} 50%, ${theme.colors.primaryLighter} 50%)"
            ></div>
            <span class="text-sm font-medium text-theme-text-primary">${theme.name}</span>
            ${
              theme.id === currentTheme
                ? `<svg class="w-4 h-4 text-theme-primary ml-auto" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                  </svg>`
                : ""
            }
          </button>
        `
        )
        .join("");

      optionsEl.querySelectorAll(".nav-theme-option").forEach((btn) => {
        btn.addEventListener("click", () => {
          const themeId = btn.getAttribute("data-theme-id");
          if (themeId) {
            saveThemePreference(themeId);
            renderOptions();
            closeDropdown();
          }
        });
      });
    }

    function openDropdown() {
      isOpen = true;
      toggleEl.setAttribute("aria-expanded", "true");
      dropdownEl.classList.remove("scale-95", "opacity-0", "pointer-events-none");
      dropdownEl.classList.add("scale-100", "opacity-100", "pointer-events-auto");
      chevronEl?.classList.add("rotate");
      renderOptions();
    }

    function closeDropdown() {
      isOpen = false;
      toggleEl.setAttribute("aria-expanded", "false");
      dropdownEl.classList.add("scale-95", "opacity-0", "pointer-events-none");
      dropdownEl.classList.remove("scale-100", "opacity-100", "pointer-events-auto");
      chevronEl?.classList.remove("rotate");
    }

    function toggleDropdown(e: Event) {
      e.stopPropagation();
      isOpen ? closeDropdown() : openDropdown();
    }

    toggleEl.addEventListener("click", toggleDropdown);

    document.addEventListener("click", (e) => {
      const switcher = document.getElementById("nav-theme-switcher");
      if (isOpen && switcher && !switcher.contains(e.target as Node)) {
        closeDropdown();
      }
    });

    document.addEventListener("keydown", (e) => {
      if (isOpen && e.key === "Escape") closeDropdown();
    });

    window.addEventListener("theme-changed", () => {
      if (isOpen) renderOptions();
    });
  }

  setupNavThemeSwitcher();
  document.addEventListener("astro:page-load", setupNavThemeSwitcher);
</script>
